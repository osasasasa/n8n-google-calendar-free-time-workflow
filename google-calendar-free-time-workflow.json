{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "sendTo": "= {{ $json.emailAddress }}",
        "subject": "=ğŸ“… {{ $json.period }}ã®ç©ºãæ™‚é–“",
        "message": "={{ $json.message }}",
        "options": {}
      },
      "id": "8a18ce42-d26f-4a93-907f-28b029477b9d",
      "name": "Gmailé€ä¿¡",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1136,
        -288
      ],
      "webhookId": "0e4f5f98-e1f9-4286-a457-f0b9493ecbfa",
      "credentials": {
        "gmailOAuth2": {
          "id": "5DVMNBWN9E1aKEbX",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å—ã‘å–ã£ãŸæœŸé–“æƒ…å ±\nconst startDateStr = $('æœŸé–“æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒ ').first().json['é–‹å§‹æ—¥'];\nconst endDateStr = $('æœŸé–“æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒ ').first().json['çµ‚äº†æ—¥'];\nconst emailAddress = $('æœŸé–“æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒ ').first().json['é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹'];\n\n// æ—¥ä»˜ã‚’DateTimeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ï¼ˆJSTï¼‰\nconst startDate = DateTime.fromISO(startDateStr).setZone('Asia/Tokyo').startOf('day');\nconst endDate = DateTime.fromISO(endDateStr).setZone('Asia/Tokyo').endOf('day');\n\n// æœŸé–“ã®è¡¨ç¤ºå½¢å¼ã‚’ä½œæˆ\nlet periodDisplay;\nif (startDate.hasSame(endDate, 'day')) {\n  periodDisplay = startDate.toFormat('yyyyå¹´MMæœˆddæ—¥');\n} else if (startDate.hasSame(endDate, 'month')) {\n  periodDisplay = `${startDate.toFormat('yyyyå¹´MMæœˆddæ—¥')}ã€œ${endDate.toFormat('ddæ—¥')}`;\n} else if (startDate.hasSame(endDate, 'year')) {\n  periodDisplay = `${startDate.toFormat('yyyyå¹´MMæœˆddæ—¥')}ã€œ${endDate.toFormat('MMæœˆddæ—¥')}`;\n} else {\n  periodDisplay = `${startDate.toFormat('yyyyå¹´MMæœˆddæ—¥')}ã€œ${endDate.toFormat('yyyyå¹´MMæœˆddæ—¥')}`;\n}\n\n// ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—\nconst events = $input.all();\n\n// å–¶æ¥­æ™‚é–“ã®è¨­å®šï¼ˆ9:00-18:00ï¼‰\nconst BUSINESS_START_HOUR = 9;\nconst BUSINESS_END_HOUR = 18;\n\n// ãƒ‡ãƒãƒƒã‚°æƒ…å ±\nconsole.log(`å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆæ•°: ${events.length}`);\nconsole.log(`å‡¦ç†æœŸé–“: ${startDate.toFormat('yyyy-MM-dd')} ã€œ ${endDate.toFormat('yyyy-MM-dd')}`);\n\n// æ—¥ä»˜åˆ¥ã®ç©ºãæ™‚é–“ã‚’æ ¼ç´ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ\nconst freeTimesByDate = {};\n\n// å‡¦ç†ã™ã‚‹æ—¥ä»˜ã®ç¯„å›²ã‚’æ—¥å˜ä½ã§ãƒ«ãƒ¼ãƒ—\nlet currentDate = startDate.startOf('day');\nwhile (currentDate <= endDate.startOf('day')) {\n  const dateKey = currentDate.toFormat('yyyy-MM-dd');\n  const dateDisplay = currentDate.toFormat('MMæœˆddæ—¥ï¼ˆcccï¼‰', {locale: 'ja'});\n  \n  // å¹³æ—¥ã®ã¿å‡¦ç†ï¼ˆåœŸæ—¥ã‚’é™¤å¤–ï¼‰\n  // æ³¨æ„: luxonã®weekdayã¯1ï¼ˆæœˆï¼‰ã‹ã‚‰7ï¼ˆæ—¥ï¼‰\n  if (currentDate.weekday >= 1 && currentDate.weekday <= 5) {\n    console.log(`å‡¦ç†ä¸­ã®æ—¥ä»˜: ${dateKey} (${dateDisplay})`);\n    \n    // ãã®æ—¥ã®äºˆå®šã‚’å–å¾—\n    const dayEvents = events.filter(item => {\n      const event = item.json;\n      if (!event.start) return false;\n      \n      const eventStart = event.start.dateTime ? \n        DateTime.fromISO(event.start.dateTime).setZone('Asia/Tokyo') : \n        DateTime.fromISO(event.start.date).setZone('Asia/Tokyo');\n      \n      return eventStart.toFormat('yyyy-MM-dd') === dateKey;\n    });\n    \n    console.log(`${dateKey}ã®äºˆå®šæ•°: ${dayEvents.length}`);\n    \n    // äºˆå®šã‚’æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ\n    const sortedEvents = dayEvents.map(item => {\n      const event = item.json;\n      const start = event.start.dateTime ? \n        DateTime.fromISO(event.start.dateTime).setZone('Asia/Tokyo') : \n        null;\n      const end = event.end?.dateTime ? \n        DateTime.fromISO(event.end.dateTime).setZone('Asia/Tokyo') : \n        null;\n      \n      return {\n        start: start,\n        end: end,\n        isAllDay: !event.start.dateTime,\n        summary: event.summary || '(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)'\n      };\n    }).filter(e => !e.isAllDay && e.start && e.end)\n      .sort((a, b) => a.start - b.start);\n    \n    console.log(`${dateKey}ã®æ™‚é–“æŒ‡å®šäºˆå®šæ•°: ${sortedEvents.length}`);\n    \n    // ç©ºãæ™‚é–“ã‚’è¨ˆç®—\n    const freeSlots = [];\n    const dayStart = currentDate.set({ hour: BUSINESS_START_HOUR, minute: 0, second: 0, millisecond: 0 });\n    const dayEnd = currentDate.set({ hour: BUSINESS_END_HOUR, minute: 0, second: 0, millisecond: 0 });\n    \n    // äºˆå®šãŒãªã„å ´åˆã¯çµ‚æ—¥ç©ºãã¨ã—ã¦å‡¦ç†\n    if (sortedEvents.length === 0) {\n      freeSlots.push({\n        start: dayStart,\n        end: dayEnd,\n        duration: dayEnd.diff(dayStart, 'minutes').minutes\n      });\n    } else {\n      let lastEndTime = dayStart;\n      \n      sortedEvents.forEach((event, index) => {\n        // ã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹ãƒ»çµ‚äº†æ™‚åˆ»ãŒå–¶æ¥­æ™‚é–“å†…ã«åã¾ã‚‹ã‚ˆã†èª¿æ•´\n        const eventStart = event.start < dayStart ? dayStart : event.start;\n        const eventEnd = event.end > dayEnd ? dayEnd : event.end;\n        \n        // å‰ã®äºˆå®šã®çµ‚äº†æ™‚åˆ»ã‹ã‚‰æ¬¡ã®äºˆå®šã®é–‹å§‹æ™‚åˆ»ã¾ã§ãŒç©ºãæ™‚é–“\n        if (eventStart > lastEndTime && lastEndTime < dayEnd) {\n          const freeEnd = eventStart < dayEnd ? eventStart : dayEnd;\n          \n          if (freeEnd > lastEndTime) {\n            const duration = freeEnd.diff(lastEndTime, 'minutes').minutes;\n            freeSlots.push({\n              start: lastEndTime,\n              end: freeEnd,\n              duration: duration\n            });\n          }\n        }\n        \n        // æ¬¡ã®ç©ºãæ™‚é–“è¨ˆç®—ã®ãŸã‚ã€çµ‚äº†æ™‚åˆ»ã‚’æ›´æ–°\n        if (eventEnd > lastEndTime) {\n          lastEndTime = eventEnd;\n        }\n      });\n      \n      // æœ€å¾Œã®äºˆå®šã‹ã‚‰å–¶æ¥­çµ‚äº†æ™‚åˆ»ã¾ã§ã®ç©ºãæ™‚é–“\n      if (lastEndTime < dayEnd) {\n        const duration = dayEnd.diff(lastEndTime, 'minutes').minutes;\n        freeSlots.push({\n          start: lastEndTime,\n          end: dayEnd,\n          duration: duration\n        });\n      }\n    }\n    \n    console.log(`${dateKey}ã®ç©ºãæ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆæ•°: ${freeSlots.length}`);\n    \n    // 30åˆ†ä»¥ä¸Šã®ç©ºãæ™‚é–“ã®ã¿ã‚’è¨˜éŒ²\n    const significantFreeSlots = freeSlots.filter(slot => slot.duration >= 30);\n    \n    console.log(`${dateKey}ã®30åˆ†ä»¥ä¸Šã®ç©ºãæ™‚é–“æ•°: ${significantFreeSlots.length}`);\n    \n    if (significantFreeSlots.length > 0) {\n      freeTimesByDate[dateKey] = {\n        display: dateDisplay,\n        slots: significantFreeSlots\n      };\n    }\n  }\n  \n  currentDate = currentDate.plus({ days: 1 });\n}\n\n// HTMLå½¢å¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ\nlet message = `<h2>ğŸ“… ${periodDisplay}ã®ç©ºãæ™‚é–“</h2>\\n`;\nmessage += `<p><strong>å–¶æ¥­æ™‚é–“: ${BUSINESS_START_HOUR}:00ã€œ${BUSINESS_END_HOUR}:00ï¼ˆå¹³æ—¥ã®ã¿ï¼‰</strong></p>\\n`;\nmessage += `<p>30åˆ†ä»¥ä¸Šã®ç©ºãæ™‚é–“ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>\\n`;\n\nconst dateKeys = Object.keys(freeTimesByDate).sort();\n\nif (dateKeys.length === 0) {\n  message += '<p style=\"color: #d9534f;\">âš ï¸ ã“ã®æœŸé–“ã«30åˆ†ä»¥ä¸Šã®ç©ºãæ™‚é–“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';\n  message += `<p style=\"font-size: 0.9em; color: #666;\">ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼š<br>`;\n  message += `- å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆç·æ•°: ${events.length}<br>`;\n  message += `- å‡¦ç†æœŸé–“: ${startDate.toFormat('yyyy-MM-dd')} ã€œ ${endDate.toFormat('yyyy-MM-dd')}</p>`;\n} else {\n  let totalFreeMinutes = 0;\n  \n  dateKeys.forEach(dateKey => {\n    const dateData = freeTimesByDate[dateKey];\n    message += `\\n<h3>â–¶ï¸ ${dateData.display}</h3>\\n`;\n    message += '<ul>\\n';\n    \n    dateData.slots.forEach(slot => {\n      const startTime = slot.start.toFormat('HH:mm');\n      const endTime = slot.end.toFormat('HH:mm');\n      const hours = Math.floor(slot.duration / 60);\n      const minutes = slot.duration % 60;\n      const durationStr = hours > 0 ? \n        `${hours}æ™‚é–“${minutes > 0 ? minutes + 'åˆ†' : ''}` : \n        `${minutes}åˆ†`;\n      \n      message += `<li>ğŸ• ${startTime}ã€œ${endTime} ï¼ˆ${durationStr}ï¼‰</li>\\n`;\n      totalFreeMinutes += slot.duration;\n    });\n    \n    message += '</ul>\\n';\n  });\n  \n  // åˆè¨ˆç©ºãæ™‚é–“ã‚’è¡¨ç¤º\n  const totalHours = Math.floor(totalFreeMinutes / 60);\n  const totalMinutesRemainder = totalFreeMinutes % 60;\n  const totalTimeStr = totalHours > 0 ? \n    `${totalHours}æ™‚é–“${totalMinutesRemainder > 0 ? totalMinutesRemainder + 'åˆ†' : ''}` : \n    `${totalMinutesRemainder}åˆ†`;\n  \n  message += `\\n<hr>\\n<p><strong>åˆè¨ˆç©ºãæ™‚é–“: ${totalTimeStr}</strong></p>`;\n}\n\n// ãƒ•ãƒƒã‚¿ãƒ¼ã‚’è¿½åŠ \nmessage += `\\n<hr>\\n<p style=\"color: #666; font-size: 0.9em;\">ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯è‡ªå‹•é€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚</p>`;\n\nreturn [{\n  json: {\n    message: message,\n    period: periodDisplay,\n    emailAddress: emailAddress\n  }\n}];"
      },
      "id": "fe4c31d1-6947-4438-b924-50983ad99e2b",
      "name": "ç©ºãæ™‚é–“è¨ˆç®—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        912,
        -288
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "primary",
          "mode": "list"
        },
        "limit": 100,
        "timeMin": "={{ $json['é–‹å§‹æ—¥'] + 'T00:00:00+09:00' }}",
        "timeMax": "={{ $json['çµ‚äº†æ—¥'] + 'T23:59:59+09:00' }}",
        "options": {
          "orderBy": "startTime"
        }
      },
      "id": "55ea6c2c-8a67-4ae5-9e9c-66c9d00898c9",
      "name": "Google Calendar",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        688,
        -288
      ],
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "dfrHQ7fbo6b381gv",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "formTitle": "Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç©ºãæ™‚é–“å–å¾—",
        "formDescription": "ç©ºãæ™‚é–“ã‚’ç¢ºèªã—ãŸã„æœŸé–“ã‚’æŒ‡å®šã—ã¦ãã ã•ã„",
        "formFields": {
          "values": [
            {
              "fieldLabel": "é–‹å§‹æ—¥",
              "fieldType": "date",
              "requiredField": true
            },
            {
              "fieldLabel": "çµ‚äº†æ—¥",
              "fieldType": "date",
              "requiredField": true
            },
            {
              "fieldLabel": "é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹",
              "requiredField": true
            }
          ]
        },
        "options": {}
      },
      "id": "832b67a9-3c80-4536-ab33-04184b5107a5",
      "name": "æœŸé–“æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒ ",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.2,
      "position": [
        464,
        -288
      ],
      "webhookId": "calendar-period"
    }
  ],
  "pinData": {},
  "connections": {
    "ç©ºãæ™‚é–“è¨ˆç®—": {
      "main": [
        [
          {
            "node": "Gmailé€ä¿¡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Calendar": {
      "main": [
        [
          {
            "node": "ç©ºãæ™‚é–“è¨ˆç®—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœŸé–“æŒ‡å®šãƒ•ã‚©ãƒ¼ãƒ ": {
      "main": [
        [
          {
            "node": "Google Calendar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "334a238c-ee4d-4f5b-a8b1-071b67ec4af0",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "1346ddaa196aa777fe6cfb2db80056779156946d5d1b6e48c4fb0b24fe34a70d"
  },
  "id": "rWnH9yF0LY56wLnu",
  "tags": []
}